import {
    VerticalBox,
    HorizontalBox,
    Button,
    ScrollView,
    Palette,
    ComboBox,
    Slider,
    Switch,
} from "std-widgets.slint";
import { ViewState } from "../api/view-state.slint";
import { ColorPickerButton } from "../components/color-picker-button.slint";
import { View } from "../components/view.slint";
import { Badge } from "../components/input/badge.slint";
import { FontEdit } from "../components/font-edit.slint";

export component MultimediaDialog inherits PopupWindow {
    close_policy: no_auto_close;
    forward_focus: focus_scope;

    property <int> fit-index: ViewState.select-media-preview.img-fit == ImageFit.fill ? 0 : (ViewState.select-media-preview.img-fit == ImageFit.contain ? 1 : 2);
    property <[string]> fit-options: ["fill", "contain", "cover"];
    property <bool> preview-mode: !ViewState.select-media-preview.content.is-empty;

    focus_scope := FocusScope {
        x: 0;
        width: 0;

        key_pressed(event) => {
            if event.text == Key.Escape {
                ViewState.in-edit-mode = { editable: false, row: -1, col: -1 };
                root.close();
                return accept;
            }
            reject
        }
    }

    Rectangle {
        x: 0;
        y: 0;
        width: 100%;
        height: 100%;
        background: Palette.background.darker(50%).with-alpha(70%);
    }

    Rectangle {
        width: 580px;
        height: 700px;
        x: (root.width / 2) - (self.width / 2);
        y: (root.height / 2) - (self.height / 2);
        background: Palette.background;
        border-width: 2px;
        border-radius: 8px;
        border-color: Palette.alternate-background.brighter(30%);

        VerticalBox {
            padding: 20px;
            spacing: 16px;

            HorizontalBox {
                alignment: space-between;
                Text {
                    text: "Configurar Fondo Multimedia";
                    font-size: 20px;
                    font-weight: 700;
                    vertical-alignment: center;
                }

                HorizontalBox {
                    spacing: 10px;
                    alignment: end;
                    Text {
                        text: "Vista Previa";
                        font-size: 13px;
                        vertical-alignment: center;
                        color: Palette.foreground;
                    }

                    Switch {
                        checked <=> preview-mode;

                        changed checked => {
                            if self.checked {
                                ViewState.select-media-preview.font = {
                                    color: Colors.white,
                                    stroke: Colors.black,
                                    stroke-size: 2px,
                                };
                                ViewState.select-media-preview.verse-font = {
                                    color: Colors.white,
                                    stroke: Colors.black,
                                    stroke-size: 2px,
                                    font-size: 24px,
                                };
                                ViewState.select-media-preview.content = "Porque de tal manera amó Dios al mundo, que ha dado a su Hijo unigénito, para que todo aquel que";
                                ViewState.select-media-preview.verse = "Juan 3:16";
                            } else {
                                ViewState.select-media-preview.content = "";
                                ViewState.select-media-preview.verse = "";
                            }
                        }
                    }
                }
            }

            Rectangle {
                width: 80%;
                height: self.width / 1.7;
                border-width: preview-mode ? 3px : 0px;
                border-color: Palette.accent-background;
                border-radius: 8px;
                animate border-width { duration: 200ms; }

                preview := View {
                    width: 100%;
                    height: 100%;
                    window-width: parent.width;
                    window-height: parent.height;
                    data: ViewState.select-media-preview;
                }

                logo-badge := Badge {
                    x: 12px;
                    y: 12px;
                    label: "Logo";
                    active: ViewState.select-media-preview.is-logo;

                    toggled(is-active) => {
                        ViewState.select-media-preview.is-logo = is-active;
                        if is-active {
                            ViewState.select-media-preview.tmp = false;
                        }
                    }
                }

                if preview-mode: Rectangle {
                    x: parent.width - self.width - 12px;
                    y: 12px;
                    width: label-preview.preferred-width + 16px;
                    height: 28px;
                    border-radius: 14px;
                    background: Palette.accent-background.with-alpha(90%);

                    label-preview := Text {
                        text: "Preview";
                        font-size: 12px;
                        font-weight: 600;
                        color: Palette.accent-foreground;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                }
            }

            ScrollView {
                vertical-stretch: 1;
                horizontal-scrollbar-policy: always-off;

                VerticalBox {
                    alignment: start;
                    spacing: 20px;

                    VerticalLayout {
                        spacing: 12px;

                        Rectangle {
                            height: 35px;
                            background: Palette.alternate-background;
                            border-radius: 6px;

                            HorizontalBox {
                                padding: 10px;
                                Text {
                                    text: "⚙️ Configuración General";
                                    font-size: 15px;
                                    font-weight: 600;
                                    vertical-alignment: center;
                                }
                            }
                        }

                        HorizontalBox {
                            spacing: 16px;
                            alignment: space-between;

                            VerticalLayout {
                                spacing: 6px;
                                Text {
                                    text: "Fondo";
                                    font-size: 13px;
                                    font-weight: 500;
                                }

                                ColorPickerButton {
                                    position: right;
                                    allow-gradient: true;
                                    selected-color: ViewState.select-media-preview.color;

                                    color-changed(color) => {
                                        ViewState.select-media-preview.color = color;
                                    }
                                }
                            }

                            VerticalLayout {
                                spacing: 6px;
                                Text {
                                    text: "Multimedia";
                                    font-size: 13px;
                                    font-weight: 500;
                                }

                                Button {
                                    text: "Seleccionar... ";
                                    clicked => {
                                        ViewState.select-file();
                                    }
                                }
                            }

                            VerticalLayout {
                                spacing: 6px;
                                Text {
                                    text: "Ajuste";
                                    font-size: 13px;
                                    font-weight: 500;
                                }

                                ComboBox {
                                    width: 130px;
                                    current-index <=> fit-index;
                                    model: fit-options;
                                    changed current-index => {
                                        if self.current-index == 0 {
                                            ViewState.select-media-preview.img-fit = ImageFit.fill;
                                        } else if self.current-index == 1 {
                                            ViewState.select-media-preview.img-fit = ImageFit.contain;
                                        } else if self.current-index == 2 {
                                            ViewState.select-media-preview.img-fit = ImageFit.cover;
                                        }
                                    }
                                }
                            }
                        }
                    }

                    FontEdit {
                        color-popup-position: right;
                        data <=> ViewState.select-media-preview;
                    }
                }
            }

            HorizontalBox {
                spacing: 12px;
                alignment: end;

                if !ViewState.select-media-preview.is-logo: Button {
                    text: "Guardar Temporal";

                    clicked => {
                        ViewState.select-media-preview.tmp = true;
                        ViewState.apply-changes(ViewState.in-edit-mode);
                        ViewState.in-edit-mode = { editable: false, row: -1, col: -1 };
                        root.close();
                    }
                }

                Button {
                    text: "Cancelar";
                    clicked => {
                        ViewState.in-edit-mode = { editable: false, row: -1, col: -1 };
                        root.close();
                    }
                }

                Button {
                    text: "Aplicar";
                    primary: true;
                    clicked => {
                        ViewState.apply-changes(ViewState.in-edit-mode);
                        ViewState.in-edit-mode = { editable: false, row: -1, col: -1 };
                        root.close();
                    }
                }
            }
        }
    }
}
