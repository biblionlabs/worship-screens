import { ViewData, ViewState } from "../api/view-state.slint";

export component View inherits Rectangle {
    in property <float> render-scale: 1.0;
    in property <length> window-width: ViewState.window-width;
    in property <length> window-height: ViewState.window-height;
    in-out property <ViewData> data: {
        show-img: false,
        color: { a: Colors.black, b: Colors.black },
    };

    clip: true;

    property <length> computed-stroke-width: data.font.stroke-size * render-scale;
    property <length> computed-verse-stroke-width: data.verse-font.stroke-size * render-scale;
    property <length> verse-bottom-offset: 30px * render-scale;

    Rectangle {
        width: parent.width;
        height: parent.height;
        background: @linear-gradient(animation-tick() / 50ms * 1deg, data.color.a, data.color.b);

        animate background { duration: 200ms; }
    }

    if data.show-img: Image {
        width: parent.width;
        height: parent.height;
        image-fit: data.img-fit;
        source: data.img-bg;
    }

    if !data.is-logo: Rectangle {
        property <length> content-height: content.preferred-height;
        property <length> verse-height: data.verse.is-empty ? 0px : verse-text.preferred-height;
        property <length> total-height: content-height + (data.verse.is-empty ? 0px : (30px * render-scale + verse-height));
        property <length> start-y: (root.window-height - total-height) / 2;

        content := Text {
            y: start-y;
            x: 0;
            width: root.window-width;
            max-height: root.window-height - (verse-height + 30px * render-scale);
            wrap: word-wrap;
            color: data.font.color;
            stroke: data.font.stroke;
            stroke-width: computed-stroke-width;
            stroke-style: outside;
            horizontal-alignment: center;
            text: data.content;
            font-family: data.font.name;
            font-size: {
                let text-length = data.content.character-count;
                let verse-space = data.verse.is-empty ? 0px : (data.verse-font.font-size * render-scale + 30px * render-scale);
                let available-height = (root.window-height - verse-space - 60px) / 1px;
                let available-width = (root.window-width - 60px) / 1px;
                let font-size-test = data.font.font-size * render-scale / 1px;
                let chars-per-line = available-width / (font-size-test * 0.65);
                let num-lines = text-length / max(1, chars-per-line);
                let line-height-factor = 1.3;
                let required-height = num-lines * font-size-test * line-height-factor;
                let scale-factor = min(1.0, available-height / required-height);
                let calculated = font-size-test * scale-factor;
                max(12px, min(data.font.font-size * render-scale, calculated * 1px))
            };
        }

        verse-text := Text {
            y: start-y + content-height + 30px * render-scale;
            x: 0;
            width: root.window-width;
            text: data.verse;
            color: data.verse-font.color;
            stroke: data.verse-font.stroke;
            stroke-width: computed-verse-stroke-width;
            stroke-style: outside;
            horizontal-alignment: center;
            font-family: data.verse-font.name;
            font-size: {
                if data.verse.is-empty {
                    return 0px;
                }
                let text-length = data.verse.character-count;
                let available-width = (root.window-width - 60px) / 1px;
                let available-height = (root.window-height - content-height - 90px * render-scale);
                let font-size-test = data.verse-font.font-size * render-scale / 1px;
                let chars-per-line = available-width / (font-size-test * 0.65);
                let num-lines = text-length / max(1, chars-per-line);
                let line-height-factor = 1.3;
                let required-height = num-lines * font-size-test * line-height-factor;
                let scale-factor = min(1px, available-height / required-height);
                let calculated = font-size-test * scale-factor;
                max(12px, min(data.verse-font.font-size * render-scale, calculated))
            };
        }
    }
}
