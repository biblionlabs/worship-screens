import { Palette, ScrollView } from "std-widgets.slint";

export component Renderable inherits VerticalLayout {
    padding-left: 5px;
    padding-right: 5px;

    in property <duration> hover-wait: 200ms;
    in property <bool> selected;
    in property <bool> removable;
    in property <bool> editable;
    in property <bool> enabled: true;
    in property <brush> background: Palette.alternate-background;
    in property <brush> border-color: enabled ? background.brighter(0.5) : background.darker(0.8);
    in property <length> border-width;
    in property <length> border-radius: 8px;
    
    // Keyboard navigation properties
    in property <int> item-index: -1;
    in property <int> focused-index: -1;
    out property <bool> has-focus: root.item-index >= 0 && root.item-index == root.focused-index;

    out property <bool> hover: false;

    callback preview();
    callback hover-preview();
    callback send-to-view();
    callback edit-click();
    callback remove-click();
    callback request-focus();

    hover-timer := Timer {
        interval: hover-wait;

        triggered => {
            hover-preview();
            self.stop();
        }
    }

    Rectangle {
        opacity: enabled ? 1.0 : 0.5;
        background: Palette.alternate-background.brighter((hover || selected || has-focus) ? 0.2 : 0.0);
        border-width: has-focus ? 2px : (border-width > 0px ? border-width : 0px);
        border-color: has-focus ? Palette.accent-background : border-color;
        border-radius: border-radius;
        animate background, border-width, border-color {
            duration: 150ms;
            easing: ease-in-out;
        }

        TouchArea {
            enabled: root.enabled;
            clicked => {
                root.request-focus();
                preview();
            }
            double-clicked => send-to-view();

            changed has-hover => {
                hover = self.has-hover;
                if self.has-hover {
                    hover-timer.start();
                } else {
                    hover-timer.stop();
                }
            }

            VerticalLayout {
                padding: 10px;

                @children
            }

            if (hover || has-focus) && enabled: HorizontalLayout {
                y: 0px;
                x: parent.width - self.width;
                alignment: end;
                spacing: 5px;

                if editable: VerticalLayout {
                    alignment: start;

                    Rectangle {
                        border-radius: 8px;
                        background: Colors.gainsboro.brighter(i-edit-hover.has-hover ? 0.2 : 0.0);
                        VerticalLayout {
                            padding: 5px;

                            Image {
                                width: 16px;
                                height: 16px;
                                source: @image-url("../../icons/edit.svg");
                            }
                        }

                        i-edit-hover := TouchArea {
                            clicked => edit-click();
                        }
                    }
                }

                if removable: VerticalLayout {
                    alignment: start;

                    VerticalLayout {
                        Rectangle {
                            border-radius: 8px;
                            background: Colors.indianred.brighter(i-rm-hover.has-hover ? 0.2 : 0.0);

                            VerticalLayout {
                                padding: 5px;
                                i-rm-content := Image {
                                    width: 16px;
                                    height: 16px;
                                    source: @image-url("../../icons/remove.svg");
                                }
                            }

                            i-rm-hover := TouchArea {
                                clicked => remove-click();
                            }
                        }
                    }
                }
            }
        }
    }
}

export component RenderableList inherits Rectangle {
    in property <int> item-count: 0;
    in-out property <int> current-focused: i-focus-scope.has-focus ? i-focus-scope.focused-item : -1;
    callback item-focused(/* index */ int);

    forward-focus: i-focus-scope;

    changed current-focused => {
        i-focus-scope.focused-item = current-focused;
    }

    i-focus-scope := FocusScope {
        property <int> focused-item: 0;
        width: 100%;
        height: 100%;
        key-pressed(event) => {
            if event.text == Key.UpArrow {
                self.focused-item = max(self.focused-item - 1, 0);
                current-focused = self.focused-item;
                root.item-focused(self.focused-item);
                return accept;
            }
            if event.text == Key.DownArrow {
                self.focused-item = min(self.focused-item + 1, root.item-count - 1);
                current-focused = self.focused-item;
                root.item-focused(self.focused-item);
                return accept;
            }
            return reject;
        }

        ScrollView {
            width: 100%;
            height: 100%;
            @children
        }
    }
}
