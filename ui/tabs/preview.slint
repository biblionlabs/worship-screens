
import { Button, TabWidget, ListView, ScrollView } from "std-widgets.slint";
import { View } from "../components/view.slint";
import { ColorPickerButton } from "../components/color-picker-button.slint";
import { FontEdit } from "../components/font-edit.slint";
import {
    RenderableList,
    Renderable,
} from "../components/base/renderable.slint";

import { ViewData, ViewState } from "../api/view-state.slint";
import { ScheduledKind, ScheduleState } from "../api/schedule.slint";

export component PreviewSection inherits VerticalLayout {
    callback send-to-view <=> send-btn.clicked;
    callback clear-image <=> clear-img-btn.clicked;
    callback schedule-request-remove(int);
    callback schedule-request-move-by(int, int);

    out property <length> preview-width <=> preview.width;
    out property <length> preview-height <=> preview.height;

    width: 30%;
    padding: 10px;
    alignment: start;
    spacing: 10px;

    control-buttons := HorizontalLayout {
        spacing: 5px;
        alignment: end;

        clear-img-btn := Button {
            visible: ViewState.shared-view.show-img;
            text: "Stop Video/Image";
        }

        send-btn := Button {
            text: "Send";
        }
    }

    preview := View {
        width: 100%;
        height: self.width / 1.7;
        window-height: 400px / 1.7;
        window-width: 400px;
        render-scale: 0.3;
        data <=> ViewState.shared-view;
    }

    color-picker := ColorPickerButton {
        height: 60px;
        position: left;
        allow-gradient: true;
        selected-color: ViewState.shared-view.color;

        color-changed(color) => {
            ViewState.shared-view.color = color;
        }
    }

    TabWidget {
        current-index: 0;
        height: 100%;

        Tab {
            title: "Edit Font";

            ScrollView {
                y: 0px;
                height: root.height - control-buttons.height - preview.height - color-picker.height - 80px;
                FontEdit {
                    show-main-title: false;
                    data <=> ViewState.shared-view;
                }
            }
        }

        Tab {
            title: "Schedule Content";

            VerticalLayout {
                y: 0px;
                spacing: 5px;
                padding-top: 5px;
                height: root.height - control-buttons.height - preview.height - color-picker.height - 80px;

                schedule-list := RenderableList {
                    item-count: ScheduleState.items.length;
                    draggable: true;
                    request-move-by(i, offset) => schedule-request-move-by(i, offset);
                    item-focused(index) => {
                        ScheduleState.select(index);
                        let it = ScheduleState.items[index];
                        ViewState.shared-view = it.view-data;
                        send-to-view();
                    }

                    ListView {
                        for it[i] in ScheduleState.items: schedule-row := Renderable {
                            padding-bottom: 10px;
                            item-index: i;
                            focused-index: schedule-list.current-focused;
                            removable: true;
                            selected: i == ScheduleState.selected-item;
                            position-shift: schedule-list.positionShiftForIndex(i);
                            draggable: schedule-list.draggable;

                            skipping(offset) => schedule-list.handleSkipping(i, offset);
                            moved-element-n-lines(offset) => schedule-list.handleMoved(i, offset);

                            remove-click => schedule-request-remove(i);
                            preview => {
                                ViewState.shared-view = it.view-data;
                            }

                            send-to-view => {
                                schedule-list.focus();
                                schedule-list.current-focused = i;
                                ViewState.shared-view = it.view-data;
                                send-to-view();
                            }

                            VerticalLayout {
                                spacing: 6px;
                                alignment: start;

                                HorizontalLayout {
                                    spacing: 8px;
                                    height: 100%;

                                    Text {
                                        vertical-alignment: center;
                                        text: it.kind == ScheduledKind.Verse ? "üìñ" : (it.kind == ScheduledKind.Song ? "üéµ" : (it.kind == ScheduledKind.Media ? "üñºÔ∏è" : "üÖ∞Ô∏è"));
                                    }

                                    Text {
                                        text: it.label;
                                        font-size: 14px;
                                        overflow: elide;
                                        wrap: word-wrap;
                                        vertical-stretch: 1;
                                        horizontal-stretch: 1;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
