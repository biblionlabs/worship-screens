import {
    ListView,
    Button,
    TabWidget,
    ComboBox,
    TextEdit,
    Palette,
    LineEdit,
    ScrollView,
} from "std-widgets.slint";

import { ViewWindow } from "view.slint";
import { SettingsWindow } from "settings.slint";

import { Bible, MainState, Settings, Verse } from "api/global.slint";
import { FileItem, SongsState } from "api/songs.slint";
import {
    EditMode,
    TextView,
    ViewData,
    ViewState,
    ViewBackgroundColor,
} from "api/view-state.slint";

import { View } from "components/view.slint";
import { MarkdownLine, MarkdownLineKind } from "components/markdown.slint";
import { ColorPicker } from "components/color-picker.slint";
import { Renderable, RenderableList } from "components/base/renderable.slint";
import { FileManagerDialog } from "dialogs/songs.slint";
import { MultimediaDialog } from "dialogs/media-selector.slint";
import { BiblesDialog } from "dialogs/bibles.slint";
import { FontEdit } from "components/font-edit.slint";
import { ColorPickerButton } from "components/color-picker-button.slint";
import { ChangelogDialog } from "dialogs/changelog.slint";
import { ScheduledKind, ScheduleState } from "api/schedule.slint";

import { VersesTab } from "tabs/verses.slint";
import { SongsTab } from "tabs/songs.slint";
import { MediaTab } from "tabs/media.slint";
import { TextTab } from "tabs/texts.slint";
import { PreviewSection } from "tabs/preview.slint";

export { Bible, EditMode, FileItem, MainState, MarkdownLine, MarkdownLineKind, ScheduledKind, ScheduleState, Settings, SettingsWindow, SongsState, TextView, Verse, ViewWindow, ViewState, ViewBackgroundColor }

export component MainWindow inherits Window {
    title: "Worship Screens";
    preferred-width: 760px;
    preferred-height: 423px;
    min-width: 1280px;
    min-height: 760px;

    in property <image> source;
    property <string> local-text;

    callback search-verse(string);

    callback start-window();
    callback open(string);
    callback open-release();

    callback shutdown-output();
    callback clear-output <=> clear-btn.clicked;
    callback clear-image <=> preview.clear-image;
    callback change-monitor <=> select-monitors.selected;

    callback send-to-view();

    callback save-text(TextView);
    callback remove-saved-text(int);

    callback add-processed-item(ViewData, ScheduledKind, string);

    callback schedule-request-remove(int);
    callback schedule-request-move-by(int, int);
    callback schedule-request-clear();

    starter-timer := Timer {
        interval: 1s;
        triggered => {
            start-window();
            ViewState.window-width = preview.preview-width;
            ViewState.window-height = preview.preview-height;
            if MainState.show-changelog-on-start {
                dialog-changelog.show();
            }
            starter-timer.stop();
        }
    }

    HorizontalLayout {
        width: parent.width;
        height: parent.height;
        alignment: space-between;

        VerticalLayout {
            width: 70%;

            HorizontalLayout {
                spacing: 5px;
                padding-left: 10px;
                padding-top: 10px;
                padding-bottom: 10px;
                padding-right: 5px;

                if MainState.need-update: Button {
                    text: "Update Available";
                    primary: true;
                    clicked => open-release();
                }

                select-monitors := ComboBox {
                    model: Settings.monitors;
                    current-index: Settings.selected-monitor;
                }

                logo-btn := Button {
                    text: "Logo";
                    clicked => ViewState.show-logo();
                }

                shutdown-btn := Button {
                    text: ViewState.off ? "On" : "Off";
                    clicked => {
                        ViewState.off = !ViewState.off;
                        shutdown-output();
                    }
                }

                clear-btn := Button {
                    text: "Clear";
                }
            }

            Rectangle {
                width: 100%;
                height: 1px;
                background: Colors.dimgray.with-alpha(20%);
            }

            central-tabs := TabWidget {
                current-index: 0;

                Tab {
                    title: "Verses";
                    VersesTab {
                        add-processed-item(vd, kind, label) => root.add-processed-item(vd, kind, label);
                        open-bibles => dialog-bibles.show();
                        send-to-view => root.send-to-view();
                        search-verse(text) => root.search-verse(text);
                    }
                }

                Tab {
                    title: "Songs";
                    SongsTab {
                        add-processed-item(vd, kind, label) => root.add-processed-item(vd, kind, label);
                        open-file-dialog => dialog-songs.show();
                        send-to-view => root.send-to-view();
                    }
                }

                Tab {
                    title: "Media";
                    MediaTab {
                        add-processed-item(vd, kind, label) => root.add-processed-item(vd, kind, label);
                        open-media-selector => dialog-media-selector.show();
                    }
                }

                Tab {
                    title: "Text";
                    TextTab {
                        save-text(data) => root.save-text(data);
                        send-to-view => root.send-to-view();
                        add-processed-item(vd, kind, label) => root.add-processed-item(vd, kind, label);
                        remove-saved-text(idx) => root.remove-saved-text(idx);
                    }
                }
            }
        }

        Rectangle {
            width: 1px;
            height: 100%;
            background: Colors.dimgray.with-alpha(20%);
        }

        preview := PreviewSection {
            send-to-view => root.send-to-view();
            schedule-request-remove(idx) => root.schedule-request-remove(idx);
            schedule-request-move-by(idx, offset) => root.schedule-request-move-by(idx, offset);
        }

        dialog-songs := FileManagerDialog {
            width: root.width;
            height: root.height;
            items: SongsState.songs-origin;
        }

        dialog-media-selector := MultimediaDialog {
            width: root.width;
            height: root.height;
        }

        dialog-bibles := BiblesDialog {
            width: root.width;
            height: root.height;
            bibles <=> MainState.bibles;
            search(query) => MainState.search-bible(query);
            install-bible(id) => MainState.install-bible(id);
        }

        dialog-changelog := ChangelogDialog {
            width: root.width;
            height: root.height;
            changelog: MainState.last-changelog;
            donate-clicked => open("https://github.com/biblionlabs/worship-screens");
            homepage-clicked => open("https://github.com/biblionlabs/worship-screens");
        }
    }
}
